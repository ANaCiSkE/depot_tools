#!/usr/bin/env bash

# Copyright 2019 The Chromium Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

if [[ $VPYTHON_BYPASS == "manually managed python not supported by chrome operations" ]]
then
  NEWARGS=()
  while [[ $# -gt 0 ]]
  do
    case "$1" in
      -vpython-tool*) # these tools all do something vpython related and quit
        exit 0
        ;;
      -vpython*=*) # delete any vpython-specific flag (w/ attached argument)
        shift
        ;;
      -vpython*) # delete any vpython-specific flag (w/ separate argument)
        shift
        shift
        ;;
      --)     # stop parsing
        NEWARGS+=( "$@" )
        break
        ;;
      *)      # regular arg
        NEWARGS+=( "$1" )
        shift
        ;;
    esac
  done
  exec "python3" "${NEWARGS[@]}"
fi


base_dir=$(dirname "$0")

source "$base_dir/cipd_bin_setup.sh"
cipd_bin_setup &> /dev/null

# If Python bootstrapping is not disabled, make sure Python has been
# bootstrapped and add it to the front of PATH.
if [[ $(uname -s) = MINGW* || $(uname -s) = CYGWIN* ]]; then
  cmd.exe //c $0.bat "$@"
elif [[ $DEPOT_TOOLS_BOOTSTRAP_PYTHON3 != 0 ]]; then
  if [[ ! -e "$base_dir/python3_bin_reldir.txt" ]]; then
    source "$base_dir/bootstrap_python3"
    bootstrap_python3
  fi

  # We want vpython to use our vendored Python, not random Python binaries that
  # may happen to be on the system. So we explicitly specify the Python binaries
  # to use via the '-vpython-interpreter' flag. We specify one for each minor
  # version we want to support. The earliest one in the list will be preferred
  # by default, with others able to be selected via "python_version" in a
  # .vpython spec file.
  #
  # This can't be baked into vpython itself without making vpython responsible
  # for managing its own Python packages, which it isn't able to do.
  interpreter_args=()
  for reldir_file in "$base_dir"/python3.*_bin_reldir.txt; do
    interpreter_args+=('-vpython-interpreter')
    interpreter_args+=("$base_dir/$(cat "$reldir_file" | xargs echo)/python3")
  done
  exec "$base_dir/.cipd_bin/vpython3" "${interpreter_args[@]}" "$@"
else
  exec "$base_dir/.cipd_bin/vpython3" "$@"
fi
